name: Upload Primer Spec Preview
on:
  pull_request:
    paths:
      - "docs/**"

jobs:
  build-and-upload-site:
    name: Build and upload Primer Spec site
    runs-on: ubuntu-latest
    steps:
      - name: 📁 Checkout code
        uses: actions/checkout@v2

      - name: 💎 Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0

      - name: 🛠 Build Jekyll site
        uses: limjh16/jekyll-action-ts@v2
        with:
          enable_cache: true

      - name: 🗜 Compress site archive
        run: |
          tar -C _site -czf _site.tar.gz --dereference .

      - name: 🚀 Upload preview site
        run: |
          pr_number=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          echo "Uploading site preview for PR #$pr_number"
          curl \
            -F "repo=seshrs/ci-playground" \
            -F "app_secret=[j%^GYLz]@sO" \
            -F "pr_number=$pr_number" \
            -F "site=@_site.tar.gz" \
            https://preview.seshrs.ml/upload
          echo "Preview should be available at https://preview.seshrs.ml/previews/seshrs/ci-playground/$pull_request_number/"
