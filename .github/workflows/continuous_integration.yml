name: Generate spec preview
on:
  pull_request:
    paths:
      - "docs/**"

jobs:
  build-and-upload-site:
    name: Build and upload
    runs-on: ubuntu-latest
    steps:
      - name: 📁 Checkout code
        uses: actions/checkout@v2

      - name: 💎 Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0

      - name: 🛠 Build Jekyll site
        uses: limjh16/jekyll-action-ts@v2
        with:
          enable_cache: true

      - name: 🗜 Compress site archive
        run: |
          tar -C _site -czf _site.tar.gz --dereference .

      - name: 🚀 Upload preview site
        run: |
          echo "Uploading site preview for PR #$PR_NUMBER"
          curl \
            -F "repo=$REPO" \
            -F "app_secret=$APP_SECRET" \
            -F "pr_number=$PR_NUMBER" \
            -F "site=@_site.tar.gz" \
            https://preview.seshrs.ml/upload-site-preview
          echo "Preview should be available at https://preview.seshrs.ml/previews/seshrs/ci-playground/$PR_NUMBER/"
        env:
          PR_NUMBER: ${{ github.event.number }}
          REPO: "seshrs/ci-playground"
          APP_SECRET: "[j%^GYLz]@sO"

      - name: 💬 Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          message: |
            The spec from this PR is available at https://preview.seshrs.ml/previews/seshrs/ci-playground/${{ github.event.number }}/.
